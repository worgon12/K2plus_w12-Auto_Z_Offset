# ===================== W12 Z-Offset System =====================
# Requirements in printer.cfg (add once, not duplicated):
# [save_variables]
# filename: ~/printer_data/config/w12_zoffset_save.cfg
# [include w12_offset.cfg]

# ---- Live Offsets (used and adjusted during prints) ----
[gcode_macro MATERIAL_OFFSETS]
variable_pla:   0.00
variable_petg:  0.025
variable_asa:   0.03
variable_abs:   0.03
variable_pc:    0.04
variable_nylon: 0.05
# Marker: 1 = delayed save to variables file after startup
variable_need_persist: 0
gcode:
    {action_respond_info(
        "OFFSETS  PLA=" ~ pla ~
        "  PETG=" ~ petg ~
        "  ASA=" ~ asa ~
        "  ABS=" ~ abs ~
        "  PC=" ~ pc ~
        "  NYLON=" ~ nylon
    )}

# ---- Auto-Sync on Startup (loads/checks, does NOT write directly) ----
[delayed_gcode AUTO_SYNC_MATERIAL_OFFSETS]
initial_duration: 1.0
gcode:
    {% set def_pla   = printer["gcode_macro MATERIAL_OFFSETS"].pla %}
    {% set def_petg  = printer["gcode_macro MATERIAL_OFFSETS"].petg %}
    {% set def_asa   = printer["gcode_macro MATERIAL_OFFSETS"].asa %}
    {% set def_abs   = printer["gcode_macro MATERIAL_OFFSETS"].abs %}
    {% set def_pc    = printer["gcode_macro MATERIAL_OFFSETS"].pc %}
    {% set def_nylon = printer["gcode_macro MATERIAL_OFFSETS"].nylon %}
    {% set cur_sig = "PLA=" ~ def_pla ~ "|PETG=" ~ def_petg ~ "|ASA=" ~ def_asa ~ "|ABS=" ~ def_abs ~ "|PC=" ~ def_pc ~ "|NYLON=" ~ def_nylon %}
    {% set sv = printer.save_variables.variables %}
    {% set saved_sig = sv.zoff_sig|default("") %}

    {% if saved_sig == "" %}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pla   VALUE={def_pla}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg  VALUE={def_petg}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=asa   VALUE={def_asa}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=abs   VALUE={def_abs}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pc    VALUE={def_pc}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=nylon VALUE={def_nylon}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=need_persist VALUE=1
        UPDATE_DELAYED_GCODE ID=AUTO_PERSIST_OFFSETS DURATION=5.0
        {action_respond_info("w12_zoffset_save.cfg empty -> Loaded defaults (save pending)")}
        M117 W12 Z Offsets initialized

    {% elif saved_sig != cur_sig %}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pla   VALUE={def_pla}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg  VALUE={def_petg}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=asa   VALUE={def_asa}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=abs   VALUE={def_abs}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pc    VALUE={def_pc}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=nylon VALUE={def_nylon}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=need_persist VALUE=1
        UPDATE_DELAYED_GCODE ID=AUTO_PERSIST_OFFSETS DURATION=5.0
        {action_respond_info("Defaults changed -> Live values updated (save pending)")}
        M117 W12 Z Offsets from defaults

    {% else %}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pla   VALUE={sv.zoff_pla|default(def_pla)}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg  VALUE={sv.zoff_petg|default(def_petg)}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=asa   VALUE={sv.zoff_asa|default(def_asa)}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=abs   VALUE={sv.zoff_abs|default(def_abs)}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pc    VALUE={sv.zoff_pc|default(def_pc)}
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=nylon VALUE={sv.zoff_nylon|default(def_nylon)}
        {action_respond_info("w12_zoffset_save.cfg loaded (User offsets active)")}
        M117 W12 Z Offsets loaded
    {% endif %}


# ---- Delayed Safe Save to w12_zoffset_save.cfg (avoids startup SHUTDOWN) ----
[delayed_gcode AUTO_PERSIST_OFFSETS]
initial_duration: 0.0
gcode:
    {% if printer["gcode_macro MATERIAL_OFFSETS"].need_persist|int == 1 %}
        SAVE_VARIABLE VARIABLE=zoff_pla   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].pla}
        SAVE_VARIABLE VARIABLE=zoff_petg  VALUE={printer["gcode_macro MATERIAL_OFFSETS"].petg}
        SAVE_VARIABLE VARIABLE=zoff_asa   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].asa}
        SAVE_VARIABLE VARIABLE=zoff_abs   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].abs}
        SAVE_VARIABLE VARIABLE=zoff_pc    VALUE={printer["gcode_macro MATERIAL_OFFSETS"].pc}
        SAVE_VARIABLE VARIABLE=zoff_nylon VALUE={printer["gcode_macro MATERIAL_OFFSETS"].nylon}
        {% set sig = "PLA=" ~ printer["gcode_macro MATERIAL_OFFSETS"].pla ~ "|" ~
                     "PETG=" ~ printer["gcode_macro MATERIAL_OFFSETS"].petg ~ "|" ~
                     "ASA=" ~ printer["gcode_macro MATERIAL_OFFSETS"].asa ~ "|" ~
                     "ABS=" ~ printer["gcode_macro MATERIAL_OFFSETS"].abs ~ "|" ~
                     "PC=" ~ printer["gcode_macro MATERIAL_OFFSETS"].pc ~ "|" ~
                     "NYLON=" ~ printer["gcode_macro MATERIAL_OFFSETS"].nylon %}
        SAVE_VARIABLE VARIABLE=zoff_sig VALUE="'{sig}'"
        SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=need_persist VALUE=0
        {action_respond_info("Offsets saved to w12_zoffset_save.cfg")}
        M117 W12 Z Offsets saved
    {% endif %}


# ---- Manual resync (no restart required) ----
[gcode_macro SYNC_OFFSETS]
gcode:
  UPDATE_DELAYED_GCODE ID=AUTO_SYNC_MATERIAL_OFFSETS DURATION=0.2


# ---- Manual save (e.g. after live adjustment) ----
[gcode_macro SAVE_FILAMENT_OFFSETS]
gcode:
    SAVE_VARIABLE VARIABLE=zoff_pla   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].pla}
    SAVE_VARIABLE VARIABLE=zoff_petg  VALUE={printer["gcode_macro MATERIAL_OFFSETS"].petg}
    SAVE_VARIABLE VARIABLE=zoff_asa   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].asa}
    SAVE_VARIABLE VARIABLE=zoff_abs   VALUE={printer["gcode_macro MATERIAL_OFFSETS"].abs}
    SAVE_VARIABLE VARIABLE=zoff_pc    VALUE={printer["gcode_macro MATERIAL_OFFSETS"].pc}
    SAVE_VARIABLE VARIABLE=zoff_nylon VALUE={printer["gcode_macro MATERIAL_OFFSETS"].nylon}
    {action_respond_info("Material offsets saved")}
    M117 W12 Z Offsets saved


# ---- Absolute set (GUI/Console) ----
[gcode_macro SET_PLA_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pla VALUE={z}
    M117 PLA Zoff {z}mm
    {action_respond_info("SET_PLA_ZOFFSET -> " ~ z ~ " mm")}

[gcode_macro SET_PETG_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg VALUE={z}
    M117 PETG Zoff {z}mm
    {action_respond_info("SET_PETG_ZOFFSET -> " ~ z ~ " mm")}

[gcode_macro SET_ASA_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=asa VALUE={z}
    M117 ASA Zoff {z}mm
    {action_respond_info("SET_ASA_ZOFFSET -> " ~ z ~ " mm")}

[gcode_macro SET_ABS_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=abs VALUE={z}
    M117 ABS Zoff {z}mm
    {action_respond_info("SET_ABS_ZOFFSET -> " ~ z ~ " mm")}

[gcode_macro SET_PC_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=pc VALUE={z}
    M117 PC Zoff {z}mm
    {action_respond_info("SET_PC_ZOFFSET -> " ~ z ~ " mm")}

[gcode_macro SET_NYLON_ZOFFSET]
gcode:
    {% set z = params.Z|float %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=nylon VALUE={z}
    M117 NYLON Zoff {z}mm
    {action_respond_info("SET_NYLON_ZOFFSET -> " ~ z ~ " mm")}


# ---- Incremental adjust (+/-), default DELTA=0.01 (example: PETG) ----
[gcode_macro INC_PETG_ZOFFSET]
gcode:
    {% set d = params.DELTA|default(0.01)|float %}
    {% set v = printer["gcode_macro MATERIAL_OFFSETS"].petg + d %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg VALUE={v}
    M117 PETG Zoff {v}mm
    {action_respond_info("INC_PETG_ZOFFSET +" ~ d ~ " -> " ~ v ~ " mm")}

[gcode_macro DEC_PETG_ZOFFSET]
gcode:
    {% set d = params.DELTA|default(0.01)|float %}
    {% set v = printer["gcode_macro MATERIAL_OFFSETS"].petg - d %}
    SET_GCODE_VARIABLE MACRO=MATERIAL_OFFSETS VARIABLE=petg VALUE={v}
    M117 PETG Zoff {v}mm
    {action_respond_info("DEC_PETG_ZOFFSET -" ~ d ~ " -> " ~ v ~ " mm")}


# ---- Apply selected material (during print) ----
[gcode_macro SET_MATERIAL_PLA]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].pla %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 PLA Zoff {z}mm
    {action_respond_info("SET_MATERIAL_PLA  Zoff=" ~ z ~ " mm")}

[gcode_macro SET_MATERIAL_PETG]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].petg %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 PETG Zoff {z}mm
    {action_respond_info("SET_MATERIAL_PETG  Zoff=" ~ z ~ " mm")}

[gcode_macro SET_MATERIAL_ASA]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].asa %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 ASA Zoff {z}mm
    {action_respond_info("SET_MATERIAL_ASA  Zoff=" ~ z ~ " mm")}

[gcode_macro SET_MATERIAL_ABS]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].abs %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 ABS Zoff {z}mm
    {action_respond_info("SET_MATERIAL_ABS  Zoff=" ~ z ~ " mm")}

[gcode_macro SET_MATERIAL_PC]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].pc %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 PC Zoff {z}mm
    {action_respond_info("SET_MATERIAL_PC  Zoff=" ~ z ~ " mm")}

[gcode_macro SET_MATERIAL_NYLON]
gcode:
    {% set z = printer["gcode_macro MATERIAL_OFFSETS"].nylon %}
    SET_GCODE_OFFSET Z={z} MOVE=1
    M117 NYLON Zoff {z}mm
    {action_respond_info("SET_MATERIAL_NYLON  Zoff=" ~ z ~ " mm")}


# ---- Wrapper: simple call like SET_MATERIAL TYPE=...
[gcode_macro SET_MATERIAL]
gcode:
    {% set t = params.TYPE|default("PLA")|lower %}
    {% set t = t.strip() %}
    {% if 'petg' in t %}
        SET_MATERIAL_PETG
    {% elif 'asa' in t %}
        SET_MATERIAL_ASA
    {% elif 'abs' in t %}
        SET_MATERIAL_ABS
    {% elif 'pc' in t or 'polycarbonate' in t %}
        SET_MATERIAL_PC
    {% elif 'nylon' in t or 'pa' in t %}
        SET_MATERIAL_NYLON
    {% elif 'pla' in t %}
        SET_MATERIAL_PLA
    {% else %}
        SET_MATERIAL_PLA
    {% endif %}
    {action_respond_info("SET_MATERIAL Z-Offset -> " ~ t)}


# ---- Display / Console shortcut
[gcode_macro SHOW_MATERIAL_OFFSET]
gcode:
    {action_respond_info(
        "PLA=" ~ printer["gcode_macro MATERIAL_OFFSETS"].pla ~
        "  PETG=" ~ printer["gcode_macro MATERIAL_OFFSETS"].petg ~
        "  ASA=" ~ printer["gcode_macro MATERIAL_OFFSETS"].asa ~
        "  ABS=" ~ printer["gcode_macro MATERIAL_OFFSETS"].abs ~
        "  PC=" ~ printer["gcode_macro MATERIAL_OFFSETS"].pc ~
        "  NYLON=" ~ printer["gcode_macro MATERIAL_OFFSETS"].nylon
    )}
    M117 PLA:{printer["gcode_macro MATERIAL_OFFSETS"].pla} PETG:{printer["gcode_macro MATERIAL_OFFSETS"].petg} ASA:{printer["gcode_macro MATERIAL_OFFSETS"].asa} ABS:{printer["gcode_macro MATERIAL_OFFSETS"].abs} PC:{printer["gcode_macro MATERIAL_OFFSETS"].pc} NYLON:{printer["gcode_macro MATERIAL_OFFSETS"].nylon}
# ===================================================================================================
